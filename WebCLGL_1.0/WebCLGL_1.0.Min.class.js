WebCLGL=function(length,unsigned){unsig=(unsigned!=undefined)?unsigned:false;this.offset=(unsig==true)?0.0:1000.0;this.W=Math.sqrt(length);this.H=this.W;var e=document.createElement('canvas');e.width=this.W;e.height=this.H;try{this.gl=e.getContext("webgl");}catch(e){this.gl=undefined;}
if(this.gl==undefined){try{this.gl=e.getContext("experimental-webgl");}catch(e){this.gl=undefined;}}
var mesh=this.loadQuad(undefined,1.0,1.0);this.vertexBuffer_QUAD=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer_QUAD);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(mesh.vertexArray),this.gl.STATIC_DRAW);this.textureBuffer_QUAD=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureBuffer_QUAD);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(mesh.textureArray),this.gl.STATIC_DRAW);this.indexBuffer_QUAD=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer_QUAD);this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(mesh.indexArray),this.gl.STATIC_DRAW);this.gl.viewport(0,0,this.W,this.H);this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null);};WebCLGL.prototype.createBuffer=function(){var webclglBuffer=new WebCLGLBuffer(this.gl,this.W*this.H,this.offset);return webclglBuffer;};WebCLGL.prototype.createKernel=function(source,header){var webclglKernel=new WebCLGLKernel(this.gl,this.W*this.H,this.offset,source,header);return webclglKernel;};WebCLGL.prototype.enqueueNDRangeKernel=function(kernel,buffer){if(kernel.isReady()==true){this.gl.useProgram(kernel.kernel);for(var n=0,f=kernel.samplers.length;n<f;n++){eval("this.gl.activeTexture(this.gl.TEXTURE"+n+");")
this.gl.bindTexture(this.gl.TEXTURE_2D,kernel.samplers[n].value.bufferData);this.gl.uniform1i(kernel.samplers[n].location,n);}
for(var n=0,f=kernel.uniformsFloat.length;n<f;n++){this.gl.uniform1f(kernel.uniformsFloat[n].location,kernel.uniformsFloat[n].value);}
this.gl.enableVertexAttribArray(kernel.attr_VertexPos);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer_QUAD);this.gl.vertexAttribPointer(kernel.attr_VertexPos,3,this.gl.FLOAT,false,0,0);this.gl.enableVertexAttribArray(kernel.attr_TextureCoord);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureBuffer_QUAD);this.gl.vertexAttribPointer(kernel.attr_TextureCoord,3,this.gl.FLOAT,false,0,0);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer_QUAD);this.gl.drawElements(this.gl.TRIANGLES,6,this.gl.UNSIGNED_SHORT,0);this.gl.readPixels(0,0,this.W,this.H,this.gl.RGBA,this.gl.UNSIGNED_BYTE,buffer.outArray4Uint8Array);buffer.enqueueWriteBuffer_4Uint8Array(buffer.outArray4Uint8Array);}else alert("kernel is not ready");};WebCLGL.prototype.loadQuad=function(node,length,height){var l=(length==undefined)?0.5:length;var h=(height==undefined)?0.5:height;this.vertexArray=[-l,-h,0.0,l,-h,0.0,l,h,0.0,-l,h,0.0];this.textureArray=[0.0,0.0,0.0,1.0,0.0,0.0,1.0,1.0,0.0,0.0,1.0,0.0];this.indexArray=[0,1,2,0,2,3];var meshObject=new Object;meshObject.vertexArray=this.vertexArray;meshObject.vertexItemSize=this.vertexItemSize;meshObject.vertexNumItems=this.vertexNumItems;meshObject.textureArray=this.textureArray;meshObject.textureItemSize=this.textureItemSize;meshObject.textureNumItems=this.textureNumItems;meshObject.indexArray=this.indexArray;meshObject.indexItemSize=this.indexItemSize;meshObject.indexNumItems=this.indexNumItems;return meshObject;};WebCLGLBuffer=function(gl,length,offset){this.gl=gl;this.W=Math.sqrt(length);this.H=this.W;this.offset=offset;var arrayX=[];for(var n=0,f=length;n<f;n++){var idd=n*4;arrayX[idd+0]=0;arrayX[idd+1]=0;arrayX[idd+2]=0;arrayX[idd+3]=0;}
this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,false);this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false);this.bufferData=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,this.bufferData);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.W,this.H,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,new Uint8Array(arrayX));this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);this.outArray4Uint8Array=new Uint8Array((this.W*this.H)*4);this.outArrayFloat32Array=[];};WebCLGLBuffer.prototype.enqueueWriteBuffer_4Uint8Array=function(arr){this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,false);this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false);this.gl.bindTexture(this.gl.TEXTURE_2D,this.bufferData);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.W,this.H,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,arr);};WebCLGLBuffer.prototype.enqueueWriteBuffer_Float32Array=function(arr){var arrayX=[];for(var n=0,f=arr.length;n<f;n++){var idd=n*4;var arrPack;if(this.offset>0.0)arrPack=this.pack((arr[n]+this.offset)/(this.offset*2));else arrPack=this.pack(arr[n]);arrayX[idd+0]=arrPack[0]*256;arrayX[idd+1]=arrPack[1]*256;arrayX[idd+2]=arrPack[2]*256;arrayX[idd+3]=arrPack[3]*256;}
this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,false);this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false);this.gl.bindTexture(this.gl.TEXTURE_2D,this.bufferData);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.W,this.H,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,new Uint8Array(arrayX));};WebCLGLBuffer.prototype.enqueueReadBuffer_4Uint8Array=function(){return this.outArray4Uint8Array;};WebCLGLBuffer.prototype.enqueueReadBuffer_Float32Array=function(){for(var n=0,f=this.outArray4Uint8Array.length/4;n<f;n++){var idd=n*4;if(this.offset>0.0)this.outArrayFloat32Array[n]=(this.unpack([this.outArray4Uint8Array[idd+0]/255,this.outArray4Uint8Array[idd+1]/255,this.outArray4Uint8Array[idd+2]/255,this.outArray4Uint8Array[idd+3]/255])*(this.offset*2))-this.offset;else this.outArrayFloat32Array[n]=parseFloat(this.unpack([this.outArray4Uint8Array[idd+0]/255,this.outArray4Uint8Array[idd+1]/255,this.outArray4Uint8Array[idd+2]/255,this.outArray4Uint8Array[idd+3]/255]).toFixed(6));}
return this.outArrayFloat32Array;};WebCLGLBuffer.prototype.dot4=function(vector4A,vector4B){return vector4A[0]*vector4B[0]+vector4A[1]*vector4B[1]+vector4A[2]*vector4B[2]+vector4A[3]*vector4B[3];};WebCLGLBuffer.prototype.fract=function(number){return number-Math.floor(number);};WebCLGLBuffer.prototype.pack=function(v){var bias=[1.0/255.0,1.0/255.0,1.0/255.0,0.0];var r=v;var g=this.fract(r*255.0);var b=this.fract(g*255.0);var a=this.fract(b*255.0);var colour=[r,g,b,a];var dd=[colour[1]*bias[0],colour[2]*bias[1],colour[3]*bias[2],colour[3]*bias[3]];return[colour[0]-dd[0],colour[1]-dd[1],colour[2]-dd[2],colour[3]-dd[3]];};WebCLGLBuffer.prototype.unpack=function(colour){var bitShifts=[1.0,1.0/255.0,1.0/(255.0*255.0),1.0/(255.0*255.0*255.0)];return this.dot4(colour,bitShifts);};WebCLGLKernel=function(gl,length,offset,source,header){this.gl=gl;this.W=Math.sqrt(length);this.H=this.W;this.offset=offset;var highPrecisionSupport=this.gl.getShaderPrecisionFormat(this.gl.FRAGMENT_SHADER,this.gl.HIGH_FLOAT);this.precision=(highPrecisionSupport!=0)?'precision highp float;\n\n':'precision mediump float;\n\n';this.ready=false;if(source!=undefined)this.setKernelSource(source,header);};WebCLGLKernel.prototype.setKernelSource=function(source,header){this.head=(header!=undefined)?header:'';this.in_values=[];var argumentsSource=source.split(')')[0].split('(')[1].split(',');for(var n=0,f=argumentsSource.length;n<f;n++){if(argumentsSource[n].match(/\*/gm)!=null){this.in_values[n]={value:undefined,type:'buffer',name:argumentsSource[n].split('*')[1].trim()};}else{this.in_values[n]={value:undefined,type:'float',name:argumentsSource[n].split(' ')[1].trim()};}}
this.source=source.split('}')[0].split('{')[1];this.source=source.replace(/^.*{/gi,'').replace(/}$/gi,'');for(var n=0,f=this.in_values.length;n<f;n++){var regexp=new RegExp(this.in_values[n].name+'\\[\\w*\\]',"gm");var varMatches=this.source.match(regexp);if(varMatches!=null){for(var nB=0,fB=varMatches.length;nB<fB;nB++){var regexp=new RegExp('\\W'+this.in_values[n].name+'\\[\\w*\\]',"gm");if(varMatches[nB].match(regexp)==null){var name=varMatches[nB].split('[')[0];var vari=varMatches[nB].split('[')[1].split(']')[0];var regexp=new RegExp(name+'\\['+vari+'\\]',"gm");this.source=this.source.replace(regexp,'in_data('+name+','+vari+')');}}}}};WebCLGLKernel.prototype.setKernelArg=function(numArgument,data){this.in_values[numArgument].value=data;if(this.ready==true)this.generateUniforms();};WebCLGLKernel.prototype.isReady=function(){if(this.ready==false)return this.compile();else return true;};WebCLGLKernel.prototype.compile=function(){this.ready=false;var readyToCompile=true;for(var n=0,f=this.in_values.length;n<f;n++){if(this.in_values[n].value==undefined){readyToCompile=false;break;}}
if(readyToCompile==true){lines_uniforms=function(in_values){str='';for(var n=0,f=in_values.length;n<f;n++){if(in_values[n].type=='buffer'){str+='uniform sampler2D '+in_values[n].name+';\n';}else{str+='uniform float '+in_values[n].name+';\n';}}
return str;};lines_in_data=function(offset){str='vec4 textureColor = texture2D(arg, coord);\n';if(offset>0.0)str+='return (unpack(textureColor)*'+parseFloat(offset*2.0).toFixed(1)+')-'+parseFloat(offset).toFixed(1)+';\n';else str+='return unpack(textureColor);\n';return str;};lines_out_data=function(offset){if(offset>0.0)return'gl_FragColor = pack((out_data+'+parseFloat(offset).toFixed(1)+')/'+parseFloat(offset*2.0).toFixed(1)+');\n';else return'gl_FragColor = pack(out_data);\n';};var sourceVertex='attribute vec3 aVertexPosition;\n'+'attribute vec2 aTextureCoord;\n'+'varying vec2 global_id;\n'+'void main(void) {\n'+'gl_Position = vec4(aVertexPosition, 1.0);\n'+'global_id = aTextureCoord;\n'+'}\n';var sourceFragment=this.precision+
lines_uniforms(this.in_values)+'varying vec2 global_id;\n'+'vec4 pack(float depth) {\n'+'const vec4 bias = vec4(1.0 / 255.0,\n'+'1.0 / 255.0,\n'+'1.0 / 255.0,\n'+'0.0);\n'+'float r = depth;\n'+'float g = fract(r * 255.0);\n'+'float b = fract(g * 255.0);\n'+'float a = fract(b * 255.0);\n'+'vec4 colour = vec4(r, g, b, a);\n'+'return colour - (colour.yzww * bias);\n'+'}\n'+'float unpack (vec4 colour) {\n'+'const vec4 bitShifts = vec4(1.0,\n'+'1.0 / 255.0,\n'+'1.0 / (255.0 * 255.0),\n'+'1.0 / (255.0 * 255.0 * 255.0));\n'+'return dot(colour, bitShifts);\n'+'}\n'+'float in_data(sampler2D arg, vec2 coord) {\n'+
lines_in_data(this.offset)+'}\n'+'vec2 get_global_id() {\n'+'return global_id;\n'+'}\n'+
this.head+'void main(void) {\n'+
this.source+
lines_out_data(this.offset)+'}\n';this.kernel=this.gl.createProgram();this.createShader("WEBCLGL",sourceVertex,sourceFragment,this.kernel);this.generateUniforms();this.attr_VertexPos=this.gl.getAttribLocation(this.kernel,"aVertexPosition");this.attr_TextureCoord=this.gl.getAttribLocation(this.kernel,"aTextureCoord");this.ready=true;return true;}else{return false;}};WebCLGLKernel.prototype.generateUniforms=function(){this.samplers=[];this.uniformsFloat=[];for(var n=0,f=this.in_values.length;n<f;n++){if(this.in_values[n].type=='buffer'){this.samplers.push({location:this.gl.getUniformLocation(this.kernel,this.in_values[n].name),value:this.in_values[n].value});}else{this.uniformsFloat.push({location:this.gl.getUniformLocation(this.kernel,this.in_values[n].name),value:this.in_values[n].value});}}};WebCLGLKernel.prototype.createShader=function(name,sourceVertex,sourceFragment,shaderProgram){var shaderVertex=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(shaderVertex,sourceVertex);this.gl.compileShader(shaderVertex);if(!this.gl.getShaderParameter(shaderVertex,this.gl.COMPILE_STATUS)){alert('Error sourceVertex of shader '+name+'. See console.');console.log('Error vertex-shader '+name+':\n '+this.gl.getShaderInfoLog(shaderVertex));}
var shaderFragment=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(shaderFragment,sourceFragment);this.gl.compileShader(shaderFragment);if(!this.gl.getShaderParameter(shaderFragment,this.gl.COMPILE_STATUS)){alert('Error sourceFragment of shader '+name+'. See console.');console.log('Error fragment-shader '+name+':\n '+this.gl.getShaderInfoLog(shaderFragment));}
this.gl.attachShader(shaderProgram,shaderVertex);this.gl.attachShader(shaderProgram,shaderFragment);this.gl.linkProgram(shaderProgram);if(!this.gl.getProgramParameter(shaderProgram,this.gl.LINK_STATUS))alert('Error in shader '+name);};